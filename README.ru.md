# Внешние события в DCSS

Данное расширение предназначено для демонстрации возможности внесения интерактивных событий в Dungeon Crawl Stone Soup.

Расширения разбито на 2 части:

* LUA-скрипты для DCSS.
* Бот для загрузки внешних событий и передачи их в игру.

## LUA-скрипты

Для подключения скриптов необходимо в папку `crawl-ref/source/dat` исходников игры скопировать папку `ext`. Для доработки/отладки скриптов можно сделать символическую ссылку.

Кроме того, в rc-файл игрока необходимо прописать импорт скрипта и вызов основного метода расширения в ready:

```lua
<
  crawl_require('ext/init.lua')

  function ready()
    ProcessExt()
  end
>
```

При старте игры игнорируются все события, что были получены ранее.

## Бот событий

### Бот Google-форм

Данный бот позволяет передавать ответы из Google-опросника посредством выгрузки таблицы ответов.

Для работы необходимо создать опрос с одним вопросом и вариантами ответа, соответствующим возможным действиям (строго один из вариантов). Каждый вариант ответа должен начинаться с кода действия (1е слово), потом допустимо свободное описание.
Ответы должны сохраняться в таблицу (настраивается в параметрах опроса).
А для таблицы необходимо включить доступ по ссылке (на чтение).

Для того, чтобы бот правильно работал, ему необходимо передать ссылку на CSV-файл, который он будет переодически скачивать (примерно раз в секунду).
Для получения из таблицы ссылки на CSV-файл необходимо получить URL вида `https://docs.google.com/spreadsheets/d/<DOC-ID>/export?format=csv`, где `<DOC-ID>` - идентификатор таблицы.

Поля CSV-файла:

* Время поступления ответа
* Необходимый эффект

Фактически бот периодически загружает CSV-файл с 2 колонками, преобразует новые записи в формат событий и выдает их на печать.
Вывод бота надо перенаправить в LUA-файл событий средствами ОС. Файл событий - `crawl-ref/source/dat/.msg.lua`.

Бот написан на Golang, так что необходимо предварительно установить компилятор Go - <https://golang.org/doc/install>.

Пример команды запуска бота:

```bash
#!/bin/bash

DOC_ID=
PATH_TO_EXT_LUA=
go run csv-bot/main.go https://docs.google.com/spreadsheets/d/$DOC_ID/export?format=csv > $PATH_TO_EXT_LUA/.msg.lua
```

### Бот twitch-чата

Данный бот позволяет передавать команды из чата twitch.

Бот читает чат, находит команды, начинающиеся с "!" и передает команду, следующую за "!" в игру.
Вывод бота надо перенаправить в LUA-файл событий средствами ОС. Файл событий - `crawl-ref/source/dat/.msg.lua`.

Бот написан на NodeJS, так что необходимо предварительно установить NodeJS.

Пример команды запуска бота:

```bash
#!/bin/bash

USER_ID=
PATH_TO_EXT_LUA=
node bot.js $USER_ID > $PATH_TO_EXT_LUA/.msg.lua
```

## Доступные эффекты

* HEAL - восстановить здоровье
* MONEY - дать 1000 монет
* ACQUIREMENT - вызвать эффект свитка приобретения
* XOM - наложить случайный эффект XOM-а
* EXTRA_LIFE - добавить 1 жизнь
* KILL - убрать 1 жизнь
* MAP - открыть карту уровня
* IDENTIFY - идентифицировать все в инвентаре
* UNIDENTIFY - убрать идентификацию со всех предметов в инвентаре
* KNOWLEDGE  - идентифицировать все предметы в игре
* UNKNOWLEDGE  - убрать идентификацию со всех предметов в игре
* RELEVEL - сгенерировать заново текущий уровень
* DETECT - определить позицию всех монстров на уровне
* KILL_ALL - убрать всех монстров на уровне
