# Внешние события в DCSS

Данный проект предназначен для добавления интерактивных событий в Dungeon Crawl Stone Soup.

Расширение разбито на 2 части:

- LUA-скрипты для DCSS.
- Бот для загрузки внешних событий и передачи их в игру.

## Доступные эффекты

- HEAL - восстановить здоровье
- MONEY - дать 1000 монет
- NO_MONEY - забрать 1000 монет
- ACQUIREMENT - выдать свиток приобретения
- XOM - наложить случайный эффект XOM-а
- EXTRA_LIFE - добавить 1 жизнь
- KILL - убрать 1 жизнь
- EXPLORE - открыть карту уровня и текущее расположение монстров
- IDENTIFY - идентифицировать все в инвентаре
- UNIDENTIFY - убрать идентификацию со всех предметов в инвентаре
- KNOWLEDGE - идентифицировать все предметы в игре
- UNKNOWLEDGE - убрать идентификацию со всех предметов в игре
- RELEVEL - сгенерировать заново текущий уровень
- BLINK - переместиться на случайную позицию в зоне видимости.
- KILL_ALL - убрать всех монстров на уровне
- MUTATION - наложение случайной мутации
- MUT_CLEAR - очистка всех мутаций

## Порядок установки и использования

1. Скопировать lua-скрипты.
2. Подключить скрипты в rc-файле.
3. Скомпилировать бот.
4. Настроить бот.
5. Запуск бота и игры.

### Скопировать lua-скрипты

Для подключения скриптов необходимо в каталог `dat` игры (или исходников игры в каталог `crawl-ref/source/dat`) скопировать папку `ext`.
Для доработки/отладки скриптов можно сделать символическую ссылку.

### Подключить скрипты в rc-файле

В rc-файл игрока необходимо добавить следующий код (импорт скрипта и вызов основного метода расширения в ready):

```lua
<
  crawl_require('ext/init.lua')

  function ready()
    ProcessExt()
  end
>
```

### Компиляция бота

Для работы бота необходимо установить NodeJS и npm.
После установки необходимо установить зависимости и скомпилировать проект:

```bash
#!/bin/bash

npm install
npm run compile
```

### Настройка бота

В файле `.env` необходимо задать настройки. Пример файла тут: `.env.example`.

Поддерживаемые настройки:

- `TWITCH_CHANNEL` (optional) - twitch-канал, с чата которого читаются события. События не сразу передаются игру, а раз в минуту выбирается случайное событие из поступивших, которое потом и передается в игру. Бот читает чат, находит сообщения, начинающиеся с "!" и передает слово, следующее за "!" в игру. Необязательная настройка.
- `CSV_URL` (optional) - загрузка событий из внешнего файла CSV-файла в сети. Позволяет организовать прием событий через Google Forms. Необязательная настройка.
- `LUA_MSG_FILE` (optional) - куда писать события. Должно указывать на файл `.msg.lua` в каталоге `ext`, скопированном ранее в игру. Необязательная настройка.

### Запуск бота и игры

Запускать бот следует строго до запуска игры - в таком случае в игру попадут только те события, что были получены во время игры.

Для запуска бота необходимо выполнить следующую команду: `npm start`. Бот печатает поступившие события в консоль. Если задана настройка `LUA_MSG_FILE`, то эти же записи дублируются в указанный файл.

После запуска бота можно запустить игру привычным игроку способом.

## Использование Google Forms для приема событий

Для работы необходимо создать опрос с одним вопросом и вариантами ответа, соответствующим возможным действиям (строго один из вариантов). Каждый вариант ответа должен начинаться с кода действия (1е слово), потом допустимо свободное описание.
Ответы должны сохраняться в таблицу (настраивается в параметрах опроса), а для самой таблицы необходимо включить доступ по ссылке (на чтение).

Для того, чтобы бот правильно работал, ему необходимо передать ссылку на CSV-файл, который он будет переодически скачивать (примерно раз в секунду).
Для получения из таблицы ссылки на CSV-файл необходимо получить URL вида `https://docs.google.com/spreadsheets/d/<DOC-ID>/export?format=csv`, где `<DOC-ID>` - идентификатор таблицы (можно взять из URL во время редактирования).

Поля CSV-файла:

- Время поступления ответа
- Вариант ответа (необходимый эффект в 1м слове ответа)
