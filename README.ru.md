# Внешние события в DCSS

Данный проект предназначен для добавления интерактивных событий в Dungeon Crawl
Stone Soup.

Расширение разбито на 2 части:

- LUA-скрипты для DCSS.
- Бот для загрузки внешних событий и передачи их в игру.

## Доступные эффекты

- MONEY - дать 1000 монет
- NO_MONEY - забрать 1000 монет
- ACQUIREMENT - выдать свиток приобретения
- EXTRA_LIFE - добавить 1 жизнь
- EXPLORE - открыть карту уровня и текущее расположение монстров
- IDENTIFY - идентифицировать все в инвентаре
- UNIDENTIFY - убрать идентификацию со всех предметов в инвентаре
- RELEVEL - сгенерировать заново текущий уровень
- BLINK - переместиться на случайную позицию в зоне видимости.
- MUTATION - наложение случайной мутации
- MUT_CLEAR - очистка всех мутаций
- BANISH_YOURSELF - отправиться в Аббис
- XOM_GIFT - получить подарок от XOM'a
- XOM_CONFUSE - законфузить монстров , хотя бы 1 монстр должен быть в поле
  видимости
- XOM_RANDOM_TELEPORT - Time to have some fun!
- BANISH_MONSTER - отправить монстра в Аббис
- TURN_INTO_BAT - превратиться в летучую мышь
- GODS_GIFT - получить подарок от текущего Бога
- EXP_POTION - выдать зелье опыта
- SUMMON_FRIEND - призвать на помощь случайного монстра соизмеримо нашему уровню
  опыта
- SUMMON_MONSTER - призвать случайного враждебного монстра соизмеримо нашему
  уровню опыта
- BLINK_YOURSELF - случайный блинк нашего персонажа
- XOM_ANIMATE_MONSTER_WEAPON - анимировать оружие у случайного враждебного
  монстра в поле видимости
- XOM_BAD_ENCHANT_MONSTER - усилить случайного враждебного монстра в поле
  видимости
- BLINK_MONSTERS_CLOSE - блинк монстров поближе к игроку
- MARK - наложить на персонажа временный статус MARK
- BERSERK - наложить на персонажа временный статус BERSERK
- TELE_TO_RANDOM_BRANCH - отправит в рандомное место (Abyss/ Bazaar / Trove /
  Gauntlet).

## Отключенные Эффекты

- HEAL - восстановить здоровье
- XOM - наложить случайный эффект XOM-а
- KILL - убрать 1 жизнь
- KNOWLEDGE - идентифицировать все предметы в игре
- UNKNOWLEDGE - убрать идентификацию со всех предметов в игре
- KILL_ALL - убрать всех монстров на уровне

## Порядок установки и использования

1. Скопировать lua-скрипты.
2. Подключить скрипты в rc-файле.
3. Скомпилировать бот.
4. Настроить бот.
5. Запуск бота и игры.

### Скопировать lua-скрипты

Для подключения скриптов необходимо в каталог `dat` игры (для исходников игры в
каталог `crawl-ref/source/dat`) скопировать папку `ext`. Для доработки/отладки
скриптов можно сделать символическую ссылку из репозитория проекта.

### Подключить скрипты в rc-файле

В rc-файл игрока необходимо добавить следующий код (импорт скрипта и вызов
основного метода расширения в ready):

```lua
<
  crawl_require('ext/init.lua')

  function ready()
    ProcessExt()
  end
>
```

### Настройка бота

Для работы бота необходимо установить [Deno](https://deno.land/).

В файле `.env` необходимо задать секретные настройки. Пример файла можно
посмотреть в `.env.example`.

Поддерживаемые настройки:

- `TWITCH_CHANNEL` (optional) - twitch-канал, с чата которого читаются события.
  События не сразу передаются игру, а раз в минуту выбирается случайное событие
  из поступивших, которое потом и передается в игру. Бот читает чат, находит
  сообщения, начинающиеся с "!" и передает слово, следующее за "!" в игру.
  Необязательная настройка.
- `CSV_URL` (optional) - загрузка событий из внешнего файла CSV-файла в сети.
  Позволяет организовать прием событий через Google Forms. Необязательная
  настройка.
- `DONATION_ALERTS_TOKEN` - токен <https://www.donationalerts.com/> для
  трансляции событий из донатов. Бот находит сообщения, начинающиеся с "!" и
  передает слово, следующее за "!" в игру. Необязательная настройка. Должна
  задаваться вместе с `DONATION_ALERTS_EVENT_PRICE`.

В файле `.config.json` можно задать прочие настройки. Пример файла можно
посмотреть в `.config.json.example`.

- `luaMsgPath` - куда писать события. Должно указывать на файл `.msg.lua` в
  каталоге `ext`, скопированном ранее в игру.
- `donationAlertPriceList` - прайс-лист событий DonationAlert. Записи в формате
  "сумма перевода: действие". Сумма перевода в формате, в котором donationalerts
  отображает сумму в виджите последних сообщений. Т.е. `150 RUB` / `15,50 RUB` /
  `10 USD`.
- `donationAlertMessages` - массив разрешенных событий из DonationAlert при
  любой сумме платежа. Сообщение с текстом события должно начинаться с "!",
  например: "!money Купи себе уже щит!".
- `twitchMessages` - массив разрешенных событий из twitch. Сообщение с текстом
  события должно начинаться с "!", например: "!money Купи себе уже щит!".
- `debugMsg` - включает отладочный вывод для всех сообщений, если задано в true.
- `refreshInterval` - период обновления данных, в миллисекундах.

### Запуск бота и игры

Запускать бот следует строго до запуска игры - в таком случае в игру попадут
только те события, что были получены во время игры.

Для запуска бота необходимо выполнить следующую команду: `deno task start`. Бот
печатает поступившие события в консоль. Если задана настройка `LUA_MSG_FILE`, то
эти же записи дублируются в указанный файл.

После запуска бота можно запустить игру привычным игроку способом. Игра читает
события из файла `.msg.lua`, в который бот и записывает события.

## Использование Google Forms для приема событий

Для работы необходимо создать опрос с одним вопросом и вариантами ответа,
соответствующим возможным действиям (строго один из вариантов). Каждый вариант
ответа должен начинаться с кода действия (первое слово), потом допустимо
свободное описание. Ответы должны сохраняться в таблицу (настраивается в
параметрах опроса), а для самой таблицы необходимо включить доступ по ссылке (на
чтение).

Для того, чтобы бот правильно работал, ему необходимо передать ссылку на
CSV-файл, который он будет переодически скачивать (примерно раз в секунду). Для
получения из таблицы ссылки на CSV-файл необходимо получить URL вида
`https://docs.google.com/spreadsheets/d/<DOC-ID>/export?format=csv`, где
`<DOC-ID>` - идентификатор таблицы (можно взять из URL во время редактирования).

Поля CSV-файла:

- Время поступления ответа
- Вариант ответа (необходимый эффект в 1м слове ответа)
